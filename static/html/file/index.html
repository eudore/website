<!doctype html>
<html>
	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="author" content="作者">
		<meta name="viewport" content="width=device-width,user-scalable=no">
		<meta name="referrer" content="always">
		<meta name="parent-id" content="" data-pjax-transient="">
		<meta name="request-id" content="ss" data-pjax-transient="">
		<script src="/js/lib/mithril.js" crossorigin="anonymous"></script>
		<script src="/js/base.js"></script>
		<script src='/js/lib/marked.min.js'></script>
		<script src='/js/lib/prism.min.js' async></script>
		<link rel="stylesheet" href='/css/lib/prism.css'>
		<link rel="stylesheet" href='/css/lib/github-markdown.css'>	
		<link rel="stylesheet" href='/css/base.css' >
	<style type="text/css">
	</style>
</head>
<body>loading</body>
<script>
	"use strict";
	var apiVersion = "/api/v1/file"
	var svgfolder1 = "M921.6 904.533333H102.4c-58.026667 0-102.4-44.373333-102.4-102.4v-512c0-58.026667 44.373333-102.4 102.4-102.4h153.6c44.373333 0 81.92 27.306667 95.573333 71.68v3.413334l3.413334 17.066666c10.24 27.306667 34.133333 44.373333 64.853333 44.373334H921.6c58.026667 0 102.4 44.373333 102.4 102.4v375.466666c0 58.026667-44.373333 102.4-102.4 102.4zM102.4 221.866667c-37.546667 0-68.266667 30.72-68.266667 68.266666v512c0 37.546667 30.72 68.266667 68.266667 68.266667h819.2c37.546667 0 68.266667-30.72 68.266667-68.266667v-375.466666c0-37.546667-30.72-68.266667-68.266667-68.266667H419.84c-44.373333 0-81.92-27.306667-95.573333-71.68v-3.413333l-3.413334-17.066667C310.613333 238.933333 283.306667 221.866667 256 221.866667H102.4z"
	var svgfolder2 = "M972.8 375.466667c-10.24 0-17.066667-6.826667-17.066667-17.066667v-136.533333c0-37.546667-30.72-68.266667-68.266666-68.266667H136.533333c-37.546667 0-68.266667 30.72-68.266666 68.266667 0 10.24-6.826667 17.066667-17.066667 17.066666S34.133333 232.106667 34.133333 221.866667c0-58.026667 44.373333-102.4 102.4-102.4h750.933334c58.026667 0 102.4 44.373333 102.4 102.4v136.533333c0 10.24-6.826667 17.066667-17.066667 17.066667z"
	var svgfile = "M803.920969 262.20065H664.932632c-7.683235 0-13.900267-6.217032-13.900268-13.900268V109.297711c0-7.683235 6.217032-13.900267 13.900268-13.900268 7.683235 0 13.900267 6.217032 13.900267 13.900268v125.10138h125.08807c7.683235 0 13.900267 6.217032 13.900267 13.900267s-6.217032 13.901291-13.900267 13.901292zM776.419409 928.840098H247.96762c-22.750732 0-41.25234-18.705361-41.25234-41.687491V137.301998c0-23.103972 18.501608-41.904555 41.25234-41.904555h416.965012c13.112899 0 19.954501 6.74638 25.451741 12.176045l115.111331 113.577551c5.741949 5.660038 12.325532 13.872622 12.325532 27.149343v638.853249c0 22.981106-18.569184 41.686467-41.401827 41.686467zM247.96762 123.197978c-7.28904 0-13.451805 6.46174-13.451806 14.10402v749.850609c0 7.655591 6.040923 13.886957 13.451806 13.886957h528.451789c7.37095 0 13.601293-6.353208 13.601293-13.886957v-638.853249c0-2.14504-0.190443-3.542643-4.045371-7.357639L670.865023 127.366215c-4.221479-4.167213-4.425232-4.167213-5.932391-4.167213H247.96762z"
	var Index = {
		Menu: [
			{name: "Overview", url: "#!/overview"},
			{name: "Files", url: "#!/data/" + Base.name + "/"},
			{name: "Basic Settings", url: "#!/settings"},
			{name: "Log Overview", url: ""},
			// {name: , url: ""},
		],
		view: function() {
			return [
				m("div.file-nav", m("ul", Index.Menu.map(function(i){
					return m("li", m("a", {href: i.url}, I18n(i.name)))
				}))),
				m("div#file-container"),
			]
		}
	}
	var Overview = {
		oninit: function(vnode) {
			m.request({
				method: 	"GET",
				url:		apiVersion + "/overview",
			}).then(function(result){
				console.log(result)
				vnode.state.count = result.count
				vnode.state.size = result.size
			})
		},
		view: function(vnode) {
			return m("div", [
				m("div", "文件数量 文件大小"),
				m("div", vnode.state.count + " " + vnode.state.size)
			])
		}
	}
	var File = {
		oninit: function(vnode) {
			this.list(vnode)
		},
		onupdate: function(vnode) {
			if(vnode.attrs.name != vnode.state.name || vnode.attrs.subpath != vnode.state.subpath) {
				this.list(vnode)
			}
		},
		upfille: function(vnode, path) {
			m.request({
				method:		"POST",
				url:		apiVersion + "/data/" + path,
				headers: {
					"Expect": "100-continue"
				}
			})
		},
		list: function(vnode) {
			m.request({
				method: "GET", 
				url: apiVersion + "/list/" + vnode.attrs.name + "/" + vnode.attrs.subpath
			}).then(function(result){
				result = result || []
				vnode.state.name = vnode.attrs.name
				vnode.state.subpath = vnode.attrs.subpath
				vnode.state.path = vnode.attrs.name + "/"
				if(vnode.attrs.subpath != "") {
					vnode.state.path += vnode.attrs.subpath + "/"
				}
				console.log(vnode.state)

				for(var i=0 ; i< result.length;i++ ) {
					var n = result[i]["path"].lastIndexOf("/") + 1
					result[i]["name"] = result[i]["path"].slice(n)
				}
				result.sort(function(a, b) {
					// 目录在前，文件在后
					if(a["size"] == -1 && b["size"] != -1) {
						return -1
					}else if(a["size"] != -1 && b["size"] == -1) {
						return 1
					}
					// 按名称排序
					return a["name"].localeCompare(b["name"])
				})
				vnode.state.data = result
			})
		},
		putfile: function(vnode, file) {
			// console.log(vnode.state, file)
			// console.log(subpath(file.webkitRelativePath))
			m.request({
				method: "PUT",
				url: apiVersion + "/data/" + vnode.state.path + 
					(file.webkitRelativePath == "" ? file.name : subpath(file.webkitRelativePath)),
				data: {
					"name": file.name,
					"size": file.size,
					"type": file.type,
					"lastModified": file.lastModified
				}
			}).then(function(result){
				File.postfile(file, result)
			})
		},
		postfile: function(file, result) {
			console.log(file)
			console.log(result)

			var data = new FormData();
			data.append("file", file)
			m.request({
				method: result.method,
				url:	result.url,
				data:	data,
			}).then(function(result) {

			})

		},
		view: function(vnode) {
			return [
				m("div.file-action", [
					m("button.file-button", I18n("Create Folder")),
					m("span.file-button", [
						m("input.input-file", {type: "file", multiple: true, onchange: function(e){
							vnode.state.files = e.target["files"]
						}})
					], I18n("Upload File")),
					m("span.file-button", [
						m("input.input-file", {type: "file", webkitdirectory: true, onchange: function(e){
							vnode.state.files = e.target["files"]
						}})
					], I18n("Upload Folder")),
					m("button.file-button", {onclick: function(){
						for(var i of vnode.state.files || []) {
							File.putfile(vnode, i)
						}
					}}, "开始上传")
				]),
				m("div.file-path"),
				vnode.state.data ? m("table", [
					m("tr", [
						m("th", ""),
						m("th", "name"),
						m("th", "size"),
						m("th", "time")
					]),
					vnode.state.data.map(function(i){
						return m("tr", [
							m("td", i["size"] == -1
								? m("svg.svg", {viewBox: "0 0 1024 1024", version: "1.1"}, [
									m("path", {d: svgfolder1}),
									m("path", {d: svgfolder2})
								])
								: m("svg.svg", {viewBox: "0 0 1024 1024", version: "1.1"}, [
									m("path", {d: svgfile})
								])
							),
							m("td", 
								m("a", {
									href: i["size"] == -1 
									? "#!/data/" + vnode.state.name + "/" + i["path"] + "/"
									: apiVersion + "/data/" + vnode.state.name + "/" + i["path"] 
								}, i["name"])
							),
							m("td", i["size"] > 1 ? i["size"] : ""),
							m("td", new Date(i["modtime"]).Format("yyyy-MM-dd"))
						])
					})
				]) : ""
			]
		}
	}

	var Settings = {
		view: function(vnode) {
			return m("div")
		}
	}

	function subpath(path) {
		var index = path.indexOf("/")
		if(index==-1) {
			return path
		}
		return path.slice(index + 1)
	}

	m.mount(document.body, Home)
	m.mount(document.getElementById('container'), Index)
	m.route(document.getElementById('file-container'), "/overview", {
		"/overview": Overview,
		"/data/:name/:subpath...":	File,
		"/settings": Settings,
	})
</script>
<style type="text/css">
	.svg {
		width: 20px;
		height: 20px;
	}
	.file-nav {
		display: flex;
	}
	.file-nav li {
		display: inline-flex;
		margin: 10px;
		border-bottom: 2px solid #fff;
	}
	.file-nav li:hover {
		border-bottom: 2px solid #ddd;
	}

	a { text-decoration: none;}
	.input-file {
		position: absolute;
		font-size: 100px;
		right: 0;
		top: 0;
		opacity: 0;
	}
	.file-button {
		position: relative;
		display: inline-block;
		background: #D0EEFF;
		border: 1px solid #99D3F5;
		border-radius: 4px;
		/*padding: 4px 12px;*/
		overflow: hidden;
		color: #1E88C7;
		text-decoration: none;
		text-indent: 0;
		line-height: 20px;
	}
	.file-button:hover {
		background: #AADFFD;
		border-color: #78C3F3;
		color: #004974;
		text-decoration: none;
	}
</style>
</html>
